<!DOCTYPE html>
<html>
<head>
    <title>IEG Visualizer</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .plot {
            width: 400px; /* Adjust the width of the plot */
            height: 300px; /* Adjust the height of the plot */
            display: inline-block; /* Display plots in a row */
            position: relative; /* Add position relative */
        }

        .arrow {
            position: absolute;
            top: 30px;
            right: 30px;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
        }

        .arrow .up-arrow {
            color: green;
        }

        .arrow .down-arrow {
            color: red;
        }
    </style>
</head>
<body>
    <h1>IEG Visualizer <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a> </h1>

    <form id="client-form" action="/visual" method="get">
        <label for="client">Select Client:</label>
        <select id="client" name="client">
            <option value="">All</option>
            {% for client in clients %}
                <option value="{{ client }}" {% if client == selected_client %}selected{% endif %}>{{ client }}</option>
            {% endfor %}
        </select>
        <button id="update-btn" type="button" class="btn btn-primary">Update</button>
    </form>
    

    <div id="charts-container"></div>

    <script type="text/javascript">
$(document).ready(function() {
    function updatePlot() {
        var selectedClient = $('#client').val();
        $.ajax({
            url: '/update_plot',
            type: 'POST',
            data: { client: selectedClient },
            success: function(response) {
                var traces = response;
                var layout = {
                    title: 'Volume vs. Date',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Volume' }
                };
                var chartsContainer = $('#charts-container');
                chartsContainer.empty();
                for (var i = 0; i < traces.length; i++) {
                    var chartId = 'chart-' + i;
                    var chartDiv = $('<div>').attr('id', chartId).addClass('plot');
                    chartsContainer.append(chartDiv);
                    var data = [traces[i]];
                    Plotly.newPlot(chartId, data, layout);

                    // Add arrow and growth percentage
                    var lastRecord = data[0].y[data[0].y.length - 1];
                    var prevRecord = data[0].y[data[0].y.length - 2];
                    var growthPercentage = ((lastRecord - prevRecord) / prevRecord) * 100;

                    var arrowDiv = $('<div>').addClass('arrow');
                    var arrowIcon = '';
                    if (growthPercentage > 0) {
                        arrowIcon = $('<i>').addClass('up-arrow').text('▲');
                    } else if (growthPercentage < 0) {
                        arrowIcon = $('<i>').addClass('down-arrow').text('▼');
                    }
                    arrowDiv.append(arrowIcon);
                    arrowDiv.append('<br>');
                    arrowDiv.append(growthPercentage.toFixed(2) + '%');
                    chartDiv.append(arrowDiv);
                }
            }
        });
    }

    function updateResults() {
        updatePlot();
    }

    // Update results every 10 seconds
    setInterval(updateResults, 20000);

    // Manual update button
    $('#update-btn').on('click', function() {
        updateResults();
    });

    // Initial plot update
    updatePlot();
});

    </script>
</body>
</html>
